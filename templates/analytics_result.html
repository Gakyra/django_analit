{% extends "base.html" %}
{% block title %}–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ ‚Äî {{ asset.name }}{% endblock %}
{% block content %}
<div class="glass p-5">
    <h2 class="mb-4 text-center">üìä {{ asset.name }} ({{ asset.symbol|upper }}) ‚Äî {{ period }} –¥–Ω—ñ–≤</h2>

    <div class="row g-4">
        <div class="col-md-4"><div class="glass p-4"><h5>üí∞ –¶—ñ–Ω–∞</h5><p class="fs-4">{{ asset.price }} USD</p></div></div>
        <div class="col-md-4"><div class="glass p-4"><h5>üìà –ó–º—ñ–Ω–∞ (24–≥)</h5><p class="fs-4">{{ asset.change }}%</p></div></div>
        <div class="col-md-4"><div class="glass p-4"><h5>üìä –í–æ–ª–∞—Ç–∏–ª—å–Ω—ñ—Å—Ç—å</h5><p class="fs-4">{{ volatility }}</p></div></div>
    </div>

    <div class="row g-4 mt-4">
        <div class="col-md-6"><div class="glass p-4"><h5>üè¶ –ö–∞–ø—ñ—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è</h5><p class="fs-5">{{ asset.market_cap|floatformat:0 }} USD</p></div></div>
        <div class="col-md-6"><div class="glass p-4"><h5>üîÑ –û–±—Å—è–≥ —Ç–æ—Ä–≥—ñ–≤</h5><p class="fs-5">{{ asset.volume|floatformat:0 }} USD</p></div></div>
    </div>

    <div class="glass p-4 mt-5">
        <h4 class="mb-3">üìâ –ì—Ä–∞—Ñ—ñ–∫ —Ü—ñ–Ω–∏ —Ç–∞ –æ–±—Å—è–≥—É</h4>
        <canvas id="priceChart" height="100"></canvas>
    </div>

    {% if forecast %}
    <div class="glass p-4 mt-4">
        <h5>üîÆ –ü—Ä–æ–≥–Ω–æ–∑: {{ forecast.direction }} –¥–æ {{ forecast.target }} USD</h5>
        <p class="text-muted">–ù–∞ –æ—Å–Ω–æ–≤—ñ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ —Ç—Ä–µ–Ω–¥—É</p>
    </div>
    {% endif %}

    <div class="mt-4">
        <h5>üß† –ù–∞—Å—Ç—Ä—ñ–π —Ä–∏–Ω–∫—É: <strong class="text-info">{{ sentiment }}</strong></h5>
        <h5>‚ö†Ô∏è –†—ñ–≤–µ–Ω—å —Ä–∏–∑–∏–∫—É: <strong class="text-warning">{{ risk_level }}</strong></h5>
    </div>

    <div class="mt-4 text-center">
        <a href="{% url 'analytics_form' %}" class="btn btn-outline-light me-2">‚Üê –ù–∞–∑–∞–¥</a>
        <a href="/analytics/candles/?asset={{ asset_id }}&interval=5m" class="btn btn-warning">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –≥—Ä–∞—Ñ—ñ–∫–∞ —Å–≤—ñ—á–æ–∫</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const rawLabels = [{% for point in chart %}{{ point.0 }},{% endfor %}];
const priceData = [{% for point in chart %}{{ point.1 }},{% endfor %}];
const volumeData = [{% for point in volume %}{{ point.1 }},{% endfor %}];
const forecastPoint = {% if forecast %}{{ forecast.target }}{% else %}null{% endif %};

const labels = rawLabels.map(ts => {
    const d = new Date(ts);
    return `${d.getDate()} ${d.toLocaleString('default', { month: 'short' })}`;
});

const ctx = document.getElementById('priceChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [
            {
                label: '–¶—ñ–Ω–∞ (USD)',
                data: priceData,
                borderColor: '#00ffc6',
                backgroundColor: 'rgba(0,255,198,0.1)',
                yAxisID: 'y',
                tension: 0.3,
                fill: true,
            },
            {
                label: '–û–±—Å—è–≥ (USD)',
                data: volumeData,
                borderColor: '#ffcc00',
                backgroundColor: 'rgba(255,204,0,0.1)',
                yAxisID: 'y1',
                type: 'bar',
            },
            {% if forecast %}
            {
                label: "–ü—Ä–æ–≥–Ω–æ–∑",
                data: Array(priceData.length - 1).fill(null).concat([forecastPoint]),
                borderColor: forecastPoint > priceData[priceData.length - 1] ? '#00ff00' : '#ff4444',
                pointBackgroundColor: forecastPoint > priceData[priceData.length - 1] ? '#00ff00' : '#ff4444',
                pointRadius: 6,
                type: 'line',
                borderDash: [5, 5],
                yAxisID: 'y',
            }
            {% endif %}
        ]
    },
    options: {
        responsive: true,
        interaction: {
            mode: 'index',
            intersect: false
        },
        stacked: false,
        plugins: {
            legend: { labels: { color: '#ccc' } },
            tooltip: { enabled: true }
        },
        scales: {
            x: { ticks: { color: '#ccc' } },
            y: {
                type: 'linear',
                position: 'left',
                ticks: { color: '#ccc' },
                title: { display: true, text: '–¶—ñ–Ω–∞', color: '#ccc' }
            },
            y1: {
                type: 'linear',
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: { color: '#ccc' },
                title: { display: true, text: '–û–±—Å—è–≥', color: '#ccc' }
            }
        }
    }
});
</script>
{% endblock %}
